# Progress Report - 2025-12-19

## 1. Overview
- **Project/Feature Name:** Backend Engineering (Scaylor AI)
- **Reporter:** Will
- **Current Phase:** Development / Deployment
- **Completion Percentage:** N/A (ongoing)
- **Next Milestone Date:** 2025-12-23

## 2. Accomplishments

### Structured Query Service - Production Deployment
- Deployed structured-query-service to all three environments (dev, staging, prod) with deterministic LLM-free matching
- Created API Gateways for all environments with X-API-Key authentication matching legacy service
- Aligned request/response contract to legacy `bigquery-querying-service`; deployed updated service
- Configured IAM permissions: run.invoker for gateways, bigquery.dataViewer/jobUser for service accounts
- Parameterized Cloud Build for per-env Artifact Registry repos; documented IAM/deploy steps
- Implemented 6 authoritative query â†’ view mappings (churn_retention, billing_health, location_scorecard, etc.)
- Imported Cloud Run service into Terraform state; aligned tfvars with live config to enable IaC management

### Cloud Run Merge Runner Infrastructure
- Added per-env Artifact Registry repos for structured-query-service (dev/staging/prod) in unification projects
- Created merge runner infra: Cloud Run Job, service account, CMEK/bucket IAM, run-profile alignment (small/medium/large/xl)
- Aligned Cloud Run merge runner with wrapper logging and GCS sync (state/unmerged/output); resolved job startup issues with explicit shell command workaround
- Verified Cloud Run IAM (storage/kms) and job args; executed job via CLI with explicit shell command

### Dataproc Merge Pipeline
- Hardened Payments handling with per-file string casting for schema clashes; verified merged output
- Added Tickets-safe reader with all-string casting to handle cross-store schema drift; merged 30.6M rows
- Handled PrepaidBooks bSendWash schema mismatch (cast to string)
- Fixed HouseAccounts merge: changed dedup key to identity+email composite, added `allow_null_merge_keys` config, recovered all 200 accounts
- Uploaded updated drivers and configs to GCS staging bucket

### PySpark Pipeline Reorganization
- Reorganized `scripts/pyspark/` from flat structure to layered architecture (entrypoints/, gold/, silver/, utils/)
- Validated local pipeline under Python 3.11 after 3.13 compatibility issues
- Regenerated gold KPI outputs on Dataproc (staging) and synced to prod/dev
- Added bottom-20 KPI view (`gold.location_scorecard_bottom`); removed unusable `payments_profile`
- Added KPI runners with model-based churn risk
- Created AGENT query snippets mapping for retrieval POC

### Documentation
- Created client-facing documentation for bronze tables with statements of purpose
- Created client-facing documentation for gold layer views
- Updated READMEs for Dataproc-based and PySpark-first architectures

### Repository Cleanup
- Merged `feature/dataproc` into `main` (10 commits); pruned 4 stale branches
- Deleted `legacy/` directory (Cloud Run code, preserved in history); cleaned 1.1 GB from metadata/

## 3. To-Dos
- Smoke-test staging and prod SQS endpoints with env API keys (High)
- Improve retrieval mapping: bottom-20 query still resolves to Billing Health (High)
- Pin Dataproc runtime version for stability in future batches (Medium)
- Confirm Dataproc cluster shutdown/status (modwash-large) (Medium)
- Optional: add validation of AR reader/writer IAM via scripted check (Low)
- Delete obsolete `feature/timeseries_statechanges` remote branch (Low)

## 4. Bugs & Issues
- **Resolved:** HouseAccounts missing 14 accounts due to null `sAccountNumber` and key collisions
- **Resolved:** Tickets schema conflicts (boolean/int/binary drift) addressed via all-string casting
- **Resolved:** Indentation error in `vertex.py` fixed by resetting to known working commit
- **Residual:** churn_risk not fully supported (ML dependencies dropped); heuristic placeholder in place
- **Residual:** Retrieval mismatch for bottom-20 query; needs doc keyword strengthening

## 5. Challenges / Blockers
- Serverless Dataproc placement stalls in multiple regions (capacity/quota); mitigated with small GCE cluster
- Local OOM during gold stage under default Spark memory; run on Dataproc instead
- Missing join keys between Payments and Customers/locations prevents revenue-based profiles

## 6. Future Plans
- Monitor HouseAccounts downstream tables for orphaned references
- Implement proper churn_risk scoring (heuristics or re-add ML with managed dependencies)
- Set up monitoring and alerting for API Gateway and Cloud Run
- Document scaylor-brain integration requirements for structured query service
- Consider adding a minimal CI check for IAM prerequisites or a deploy checklist

## 7. References
- **Related Docs:**
  - `docs/global/INFRA_deployment.md`
  - `docs/global/INFRA_dataproc_migration.md`
  - `docs/global/INFRA_modwash_unification_merge.md`
  - `docs/global/INFRA_run_profiles.md`
  - `docs/global/ARCH_pyspark_reorg.md`
  - `docs/global/DEBUG_house_accounts_merge.md`
- **Related Commits:**
  - `df0733b` - SQS base deployment commit
  - `f898806`, `3e779bb`, `2d0351b` - SQS contract alignment and Cloud Build params
  - `df9724f`, `998137f` - Merge runner + structured-query AR setup
  - `c9d37f3` - Cloud Run merge runner alignment
  - `2081763` - HouseAccounts merge fix
  - `45a3fb3` - PrepaidBooks schema mismatch handling
  - `d01e393` - README update for Dataproc architecture
  - `8c6fb67` - Client-facing bronze table documentation
  - `31ead10` - Gold layer views documentation
- **Related Tickets:** SCA-477, SCA-478, SCA-479, PROC-001/002/003

